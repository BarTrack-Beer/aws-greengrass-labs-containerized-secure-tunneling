---
RecipeFormatVersion: '2020-01-25'
ComponentName: com.bartrack.SecureTunneling
ComponentVersion: '1.0.13'
ComponentDescription: 'AWS IoT Secure Tunneling for Greengrass Nucleus Lite 2.3.0 with Docker CE and ECR authentication'
ComponentPublisher: BarTrack
ComponentDependencies:
  aws.greengrass.TokenExchangeService:
    VersionRequirement: '>=2.0.0'
    DependencyType: SOFT
ComponentConfiguration:
  DefaultConfiguration:
    dockerImage: '362106343162.dkr.ecr.us-east-2.amazonaws.com/secure-tunneling:1.0.0'
    containerName: 'secure-tunneling'
Manifests:
  - Platform:
      os: linux
      architecture: arm
      runtime: aws_nucleus_lite
    Lifecycle:
      RunWith:
        posixUser: gg_component:gg_component
      Run:
        Script: |
          #!/bin/bash
          set -x  # Enable debug tracing
          
          echo "========================================="
          echo "SecureTunneling Component Starting v1.0.13"
          echo "========================================="
          
          # Configuration
          CONTAINER_NAME="{configuration:/containerName}"
          DOCKER_IMAGE="{configuration:/dockerImage}"
          
          echo "DEBUG: Container name: $CONTAINER_NAME"
          echo "DEBUG: Docker image: $DOCKER_IMAGE"
          
          # Get AWS environment variables from Greengrass (TES provides these)
          if [ -z "$AWS_REGION" ]; then
            AWS_REGION="us-east-2"
          fi
          if [ -z "$AWS_IOT_THING_NAME" ]; then
            AWS_IOT_THING_NAME=$(hostname)
          fi
          
          echo "DEBUG: AWS Region: $AWS_REGION"
          echo "DEBUG: Thing Name: $AWS_IOT_THING_NAME"
          
          # Check for TES environment variables (needed for ECR authentication)
          if [ -n "$AWS_CONTAINER_CREDENTIALS_FULL_URI" ]; then
            echo "DEBUG: TES credentials URI: $AWS_CONTAINER_CREDENTIALS_FULL_URI"
          else
            echo "WARNING: AWS_CONTAINER_CREDENTIALS_FULL_URI not set"
          fi
          
          # Check Docker availability
          echo "DEBUG: Checking docker availability..."
          if ! command -v docker > /dev/null 2>&1; then
            echo "ERROR: docker command not found!"
            exit 1
          fi
          
          echo "DEBUG: docker version:"
          docker --version || echo "WARNING: Could not get docker version"
          
          # Export TES environment variables for ECR credential helper
          # These are automatically set by Greengrass for component processes
          export AWS_REGION
          export AWS_CONTAINER_CREDENTIALS_FULL_URI
          export AWS_CONTAINER_AUTHORIZATION_TOKEN
          
          # Pull Docker image using ECR credential helper
          echo "DEBUG: Pulling ECR image: $DOCKER_IMAGE"
          echo "DEBUG: ECR credential helper will use TES for authentication"
          if docker pull "$DOCKER_IMAGE"; then
            echo "DEBUG: Image pull successful"
          else
            echo "WARNING: Image pull failed, attempting to use cached image"
            if ! docker images | grep -q "$DOCKER_IMAGE"; then
              echo "ERROR: No cached image found for $DOCKER_IMAGE"
              echo "ERROR: ECR authentication failed - check TES is running and ECR credential helper is configured"
              exit 1
            fi
          fi
          
          echo "DEBUG: Checking for existing container..."
          if docker ps -a | grep -q "$CONTAINER_NAME"; then
            echo "DEBUG: Found existing container, stopping and removing..."
            docker stop "$CONTAINER_NAME" 2>&1 || echo "WARNING: Stop failed"
            docker rm "$CONTAINER_NAME" 2>&1 || echo "WARNING: Remove failed"
          fi
          
          # Run container with optimized settings for Nucleus Lite
          echo "DEBUG: Starting container with settings:"
          echo "  - Name: $CONTAINER_NAME"
          echo "  - Image: $DOCKER_IMAGE"
          echo "  - Memory: 512MB"
          echo "  - Network: host"
          
          if docker run -d \
            --name "$CONTAINER_NAME" \
            --restart unless-stopped \
            --network host \
            --memory=512m \
            --memory-swap=512m \
            -e AWS_REGION="$AWS_REGION" \
            -e AWS_IOT_THING_NAME="$AWS_IOT_THING_NAME" \
            "$DOCKER_IMAGE"; then
            echo "SUCCESS: Container started successfully"
          else
            echo "ERROR: Container failed to start"
            exit 1
          fi
          
          echo "DEBUG: Verifying container is running..."
          sleep 2
          if docker ps | grep -q "$CONTAINER_NAME"; then
            echo "SUCCESS: Container verified running"
          else
            echo "ERROR: Container not found in running containers"
            echo "DEBUG: Container logs:"
            docker logs "$CONTAINER_NAME" 2>&1 || echo "No logs available"
            exit 1
          fi
          
          # Monitor container health
          while true; do
            if ! docker ps --filter "name=$CONTAINER_NAME" --filter "status=running" | grep -q "$CONTAINER_NAME"; then
              echo "ERROR: Container $CONTAINER_NAME is not running!"
              docker logs "$CONTAINER_NAME" 2>&1 | tail -50
              exit 1
            fi
            sleep 30
          done
      Shutdown:
        Script: |
          #!/bin/bash
          set -x  # Enable debug tracing
          
          echo "========================================="
          echo "SecureTunneling Component Shutting Down"
          echo "========================================="
          
          CONTAINER_NAME="{configuration:/containerName}"
          echo "DEBUG: Stopping container: $CONTAINER_NAME"
          
          if docker stop "$CONTAINER_NAME" 2>&1; then
            echo "DEBUG: Container stopped successfully"
          else
            echo "WARNING: Container stop failed or container not running"
          fi
          
          if docker rm "$CONTAINER_NAME" 2>&1; then
            echo "DEBUG: Container removed successfully"
          else
            echo "WARNING: Container remove failed or container not found"
          fi
          
          echo "SUCCESS: Shutdown complete"
